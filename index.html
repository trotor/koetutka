<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koetutka - Noutajakokeet l√§hell√§ sinua</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #2d5a27 0%, #1a472a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: url('banner.jpg') center center;
            background-size: cover;
            height: 0;
            padding-bottom: 17.58%; /* 270/1536 = 17.58% aspect ratio */
            position: relative;
            border-bottom: 3px solid #2d5a27;
        }

        header h1,
        header p {
            position: absolute;
            left: -9999px;
            /* Teksti on jo bannerissa, piilotetaan mutta s√§ilytet√§√§n saavutettavuudelle */
        }

        .location-selector {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #2d5a27;
        }

        .location-selector h2 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
        }

        .location-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .location-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .location-input-wrapper input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .location-input-wrapper input:focus {
            outline: none;
            border-color: #2d5a27;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background: #f0f0f0;
        }

        .btn-gps {
            padding: 12px 20px;
            background: #2d5a27;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-gps:hover {
            background: #1a472a;
        }

        .btn-gps:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .current-location {
            padding: 10px 15px;
            background: #e8f5e9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-location .location-name {
            font-weight: 600;
            color: #2d5a27;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 1.8em;
            color: #2d5a27;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.85em;
        }

        /* Mobile stats - compact horizontal */
        .stats-mobile {
            display: none;
            padding: 12px 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .stats-mobile-inner {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat-pill {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: #e3f2fd;
            border-radius: 16px;
            font-size: 0.85em;
            white-space: nowrap;
            border: 1px solid #bbdefb;
        }

        .stat-pill-total {
            background: #1565c0;
            color: white;
            font-weight: 600;
            border-color: #1565c0;
        }

        .stat-pill-count {
            font-weight: 700;
            color: #1565c0;
        }

        .stat-pill-total .stat-pill-count {
            color: white;
        }

        .stat-pill-label {
            color: #1976d2;
        }

        .stat-pill-total .stat-pill-label {
            color: rgba(255,255,255,0.9);
        }

        .filters {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filters label {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }

        .filters input, .filters select {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #2d5a27;
        }

        .pill-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .pill {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid #ddd;
            background: white;
            color: #666;
            transition: all 0.2s;
            user-select: none;
        }

        .pill:hover {
            border-color: #2d5a27;
            background: #f8f9fa;
        }

        .pill.active {
            background: #2d5a27;
            color: white;
            border-color: #2d5a27;
        }

        .pill.active:hover {
            background: #1a472a;
            border-color: #1a472a;
        }

        .pill-count {
            font-size: 0.85em;
            opacity: 0.7;
        }

        .pill.active .pill-count {
            opacity: 0.9;
        }

        .help-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: auto;
        }

        .help-btn:hover {
            background: #e0e0e0;
        }

        .sort-info {
            margin-left: auto;
            font-size: 0.9em;
            color: #666;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #2d5a27;
            color: white;
            position: sticky;
            top: 0;
        }

        thead th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        thead th:hover {
            background: #1a472a;
        }

        thead th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
        }

        thead th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        thead th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody td {
            padding: 12px 15px;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .type-NOME-B { background: #e3f2fd; color: #1565c0; }
        .type-NOWT { background: #f3e5f5; color: #6a1b9a; }
        .type-NOU { background: #e8f5e9; color: #2e7d32; }

        .distance {
            font-weight: 600;
            color: #2d5a27;
        }

        .distance-unknown {
            color: #999;
            font-style: italic;
        }

        .date {
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2em;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .btn-calendar {
            background: #4CAF50;
            color: white;
        }

        .btn-calendar:hover {
            background: #45a049;
        }

        .btn-snj {
            display: inline-block;
            padding: 12px 24px;
            background: #2d5a27;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn-snj:hover {
            background: #1a472a;
            color: white;
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

        .btn-info:hover {
            background: #0b7dda;
        }

        .btn-icon {
            font-size: 1.1em;
        }

        .btn-text {
            margin-left: 3px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #000;
        }

        .info-section {
            margin: 15px 0;
        }

        .info-section h3 {
            color: #2d5a27;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .info-section p {
            margin: 5px 0;
            line-height: 1.8;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        footer {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            color: #666;
            font-size: 0.9em;
            line-height: 1.8;
        }

        footer a {
            color: #2d5a27;
            text-decoration: none;
            font-weight: 600;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .footer-separator {
            margin: 0 8px;
            color: #ccc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Card layout - full width, no side margins */
        .cards-container {
            display: flex;
            flex-direction: column;
            padding: 12px 0;
            gap: 10px;
            background: #f5f5f5;
        }

        /* Hide table, use cards instead */
        #kokeTable {
            display: none !important;
        }

        .event-card {
            background: white;
            padding: 14px 24px;
            border-left: 4px solid #2d5a27;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            /* Desktop: horizontal layout */
            display: grid;
            grid-template-columns: 70px 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .event-card:hover {
            background: #f8faf8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .card-distance {
            font-weight: 700;
            font-size: 1.1em;
            color: #2d5a27;
            text-align: center;
        }

        .card-distance-label {
            font-size: 0.75em;
            color: #666;
            font-weight: 400;
        }

        .card-main-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .card-title {
            font-weight: 600;
            font-size: 1em;
            color: #333;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-subtitle {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            font-size: 0.9em;
            color: #666;
        }

        .card-subtitle-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-date {
            font-weight: 600;
            color: #333;
        }

        .card-calendar-link {
            color: #1565c0;
            cursor: pointer;
            text-decoration: none;
            border-bottom: 1px dashed #1565c0;
            transition: color 0.15s;
        }

        .card-calendar-link:hover {
            color: #0d47a1;
            border-bottom-style: solid;
        }

        .card-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Desktop: show organizer inline */
        .card-organizer {
            display: inline;
        }

        /* Hide mobile-only elements on desktop */
        .card-meta-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .location-controls {
                flex-direction: column;
            }

            .location-input-wrapper {
                width: 100%;
            }

            .btn-gps {
                width: 100%;
                justify-content: center;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filters input {
                width: 100%;
            }

            .pill-container {
                width: 100%;
            }

            .pill {
                font-size: 0.75em;
                padding: 5px 10px;
            }

            .sort-info {
                margin-left: 0;
                text-align: center;
            }

            .table-container {
                padding: 10px;
            }

            /* Mobile card layout - stacked */
            .cards-container {
                padding: 8px 0;
                gap: 10px;
            }

            .event-card {
                display: block;
                padding: 12px 16px;
            }

            .card-distance {
                float: right;
                margin-left: 12px;
                text-align: right;
            }

            .card-main-info {
                margin-bottom: 8px;
            }

            .card-title {
                white-space: normal;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                margin-bottom: 6px;
            }

            .card-subtitle {
                font-size: 0.85em;
            }

            .card-badges {
                margin: 8px 0;
                clear: both;
            }

            .card-meta-mobile {
                display: flex;
                flex-wrap: wrap;
                gap: 6px 12px;
                font-size: 0.8em;
                color: #666;
                padding-top: 8px;
                border-top: 1px solid #eee;
            }

            .card-meta-item {
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .card-organizer {
                display: none;
            }

            /* Hide desktop stats, show mobile stats */
            .stats {
                display: none !important;
            }

            .stats-mobile {
                display: block;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
                max-height: 85vh;
            }

            footer {
                font-size: 0.8em;
                padding: 15px;
            }

            .footer-separator {
                display: none;
            }

            footer p {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Koetutka</h1>
            <p>Noutajakokeet l√§hell√§ sinua</p>
        </header>

        <div class="location-selector">
            <h2>Valitse sijaintisi</h2>
            <div class="location-controls">
                <div class="location-input-wrapper">
                    <input type="text" id="locationInput" placeholder="Kirjoita paikkakunta..." autocomplete="off">
                    <div id="suggestions" class="suggestions"></div>
                </div>
                <button class="btn-gps" id="gpsButton" onclick="useGPS()">
                    <span>üìç</span> K√§yt√§ sijaintiani
                </button>
                <div class="current-location" id="currentLocation" style="display: none;">
                    <span>üìç</span>
                    <span class="location-name" id="locationName">Kuopio</span>
                </div>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3 id="totalCount">-</h3>
                <p>Koetta yhteens√§</p>
            </div>
        </div>
        <div class="stats-mobile" id="statsMobile">
            <div class="stats-mobile-inner" id="statsMobileInner"></div>
        </div>

        <div class="filters">
            <div class="filter-row">
                <label for="searchInput">Haku:</label>
                <input type="text" id="searchInput" placeholder="Paikkakunta, tyyppi tai taso...">
            </div>

            <div class="filter-row">
                <label>J√§rjestys:</label>
                <div class="pill-container">
                    <div class="pill active" data-sort="distance" onclick="setSortOrder('distance')">
                        <span class="pill-label">üìç Et√§isyys</span>
                    </div>
                    <div class="pill" data-sort="date" onclick="setSortOrder('date')">
                        <span class="pill-label">üìÖ Ajankohta</span>
                    </div>
                </div>
                <button class="help-btn" onclick="showHelp()" title="Ohjeet">‚ùì</button>
            </div>

            <div class="filter-row">
                <label>Laji:</label>
                <div class="pill-container" id="typePills"></div>
            </div>

            <div class="filter-row">
                <label>Taso:</label>
                <div class="pill-container" id="levelPills"></div>
            </div>
        </div>

        <div class="table-container">
            <div id="loadingIndicator" class="loading">Ladataan kokeita</div>
            <table id="kokeTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="distance" data-type="number">Et√§isyys</th>
                        <th class="sortable" data-sort="date" data-type="date">P√§iv√§</th>
                        <th class="sortable" data-sort="location" data-type="string">Paikkakunta</th>
                        <th></th>
                        <th class="sortable" data-sort="type" data-type="string">Tyyppi</th>
                        <th class="sortable" data-sort="levels" data-type="string">Taso</th>
                        <th class="sortable" data-sort="entry_date" data-type="string">Ilmoittautuminen</th>
                        <th>üìÖ</th>
                    </tr>
                </thead>
                <tbody id="kokeTableBody">
                </tbody>
            </table>
            <div id="cardsContainer" class="cards-container"></div>
            <div id="noResults" class="no-results" style="display: none;">
                Ei tuloksia haulle
            </div>
        </div>

        <!-- Info Modal -->
        <div id="infoModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <div id="modalBody"></div>
            </div>
        </div>

        <footer>
            <p>
                Data: SNJ koekalenteri | <span id="updateDate"></span>
            </p>
            <p>
                Tekij√§: <a href="https://github.com/trotor" target="_blank" rel="noopener">Tero R√∂nkk√∂</a>
                <span class="footer-separator">|</span>
                <a href="mailto:tero@savonnuuskut.com">tero@savonnuuskut.com</a>
                <span class="footer-separator">|</span>
                <a href="https://github.com/trotor/koetutka" target="_blank" rel="noopener">GitHub</a>
                <span class="footer-separator">|</span>
                <span id="version">v1.3.1</span>
            </p>
        </footer>
    </div>

    <script>
        // Suomen kaupunkien koordinaatit (yleisimm√§t)
        const finnishCities = {
            'kuopio': { lat: 62.8924, lng: 27.6782 },
            'helsinki': { lat: 60.1699, lng: 24.9384 },
            'espoo': { lat: 60.2055, lng: 24.6559 },
            'tampere': { lat: 61.4978, lng: 23.7610 },
            'vantaa': { lat: 60.2934, lng: 25.0378 },
            'oulu': { lat: 65.0121, lng: 25.4651 },
            'turku': { lat: 60.4518, lng: 22.2666 },
            'jyv√§skyl√§': { lat: 62.2426, lng: 25.7473 },
            'lahti': { lat: 60.9827, lng: 25.6612 },
            'pori': { lat: 61.4851, lng: 21.7974 },
            'kouvola': { lat: 60.8679, lng: 26.7042 },
            'joensuu': { lat: 62.6010, lng: 29.7636 },
            'lappeenranta': { lat: 61.0587, lng: 28.1887 },
            'h√§meenlinna': { lat: 60.9959, lng: 24.4644 },
            'vaasa': { lat: 63.0960, lng: 21.6158 },
            'sein√§joki': { lat: 62.7876, lng: 22.8402 },
            'rovaniemi': { lat: 66.5039, lng: 25.7294 },
            'mikkeli': { lat: 61.6886, lng: 27.2723 },
            'kotka': { lat: 60.4664, lng: 26.9458 },
            'salo': { lat: 60.3833, lng: 23.1333 },
            'porvoo': { lat: 60.3929, lng: 25.6641 },
            'kokkola': { lat: 63.8376, lng: 23.1305 },
            'lohja': { lat: 60.2500, lng: 24.0667 },
            'hyvink√§√§': { lat: 60.6306, lng: 24.8597 },
            'nurmij√§rvi': { lat: 60.4722, lng: 24.8083 },
            'j√§rvenp√§√§': { lat: 60.4739, lng: 25.0892 },
            'rauma': { lat: 61.1275, lng: 21.5111 },
            'kajaani': { lat: 64.2270, lng: 27.7285 },
            'kerava': { lat: 60.4028, lng: 25.1053 },
            'savonlinna': { lat: 61.8687, lng: 28.8789 },
            'nokia': { lat: 61.4775, lng: 23.5080 },
            'yl√∂j√§rvi': { lat: 61.5548, lng: 23.5847 },
            'kaarina': { lat: 60.4067, lng: 22.3667 },
            'kangasala': { lat: 61.4639, lng: 24.0764 },
            'varkaus': { lat: 62.3150, lng: 27.8728 },
            'imatra': { lat: 61.1931, lng: 28.7764 },
            'riihim√§ki': { lat: 60.7386, lng: 24.7722 },
            'raasepori': { lat: 59.9728, lng: 23.4364 },
            'hollola': { lat: 60.9872, lng: 25.5128 },
            'lemp√§√§l√§': { lat: 61.3139, lng: 23.7522 },
            'tornio': { lat: 65.8492, lng: 24.1467 },
            'siilinj√§rvi': { lat: 63.0833, lng: 27.6667 },
            'valkeakoski': { lat: 61.2639, lng: 24.0292 },
            'iisalmi': { lat: 63.5583, lng: 27.1917 },
            'pietarsaari': { lat: 63.6750, lng: 22.7028 },
            'kemi': { lat: 65.7364, lng: 24.5636 },
            'forssa': { lat: 60.8164, lng: 23.6236 },
            'heinola': { lat: 61.2067, lng: 26.0333 },
            'pieks√§m√§ki': { lat: 62.3000, lng: 27.1583 },
            'ylivieska': { lat: 64.0722, lng: 24.5375 },
            'hamina': { lat: 60.5697, lng: 27.1983 },
            'naantali': { lat: 60.4681, lng: 22.0264 },
            'raahe': { lat: 64.6847, lng: 24.4792 },
            'laukaa': { lat: 62.4139, lng: 25.9500 },
            'kuusamo': { lat: 65.9667, lng: 29.1833 },
            'j√§ms√§': { lat: 61.8639, lng: 25.1903 },
            '√§√§nekoski': { lat: 62.6028, lng: 25.7264 },
            'loviisa': { lat: 60.4569, lng: 26.2250 },
            'raisio': { lat: 60.4861, lng: 22.1694 },
            'uusikaupunki': { lat: 60.8000, lng: 21.4083 },
            'lapua': { lat: 62.9708, lng: 23.0056 },
            'vihti': { lat: 60.4167, lng: 24.3333 },
            'lieksa': { lat: 63.3167, lng: 30.0167 },
            'kurikka': { lat: 62.6194, lng: 22.4083 },
            'kitee': { lat: 62.1000, lng: 30.1333 },
            'nurmes': { lat: 63.5417, lng: 29.1333 },
            'kontiolahti': { lat: 62.7667, lng: 29.8500 },
            'liperi': { lat: 62.5333, lng: 29.3833 },
            'outokumpu': { lat: 62.7250, lng: 29.0167 },
            'kankaanp√§√§': { lat: 61.8042, lng: 22.3917 },
            'paimio': { lat: 60.4569, lng: 22.6861 },
            'eurajoki': { lat: 61.2000, lng: 21.7333 },
            'huittinen': { lat: 61.1764, lng: 22.6972 },
            'harjavalta': { lat: 61.3139, lng: 22.1417 },
            'ulvila': { lat: 61.4292, lng: 21.8750 },
            'kokem√§ki': { lat: 61.2556, lng: 22.3528 },
            'laitila': { lat: 60.8764, lng: 21.6972 },
            'eura': { lat: 61.1292, lng: 22.1333 },
            's√§kyl√§': { lat: 61.0500, lng: 22.3333 },
            'nakkila': { lat: 61.3667, lng: 22.0000 },
            'lieto': { lat: 60.5000, lng: 22.4500 },
            'parainen': { lat: 60.3000, lng: 22.3000 },
            'masku': { lat: 60.5708, lng: 22.1000 },
            'myn√§m√§ki': { lat: 60.6833, lng: 21.9833 },
            'nousiainen': { lat: 60.6000, lng: 22.0833 },
            'aura': { lat: 60.6500, lng: 22.5833 },
            'p√∂yty√§': { lat: 60.7167, lng: 22.6167 },
            'somero': { lat: 60.6333, lng: 23.5167 },
        };

        let kokeet = [];
        let filteredKokeet = [];
        let userLocation = { lat: 62.8924, lng: 27.6782, name: 'Kuopio' }; // Oletus: Kuopio
        let currentSort = { column: 'distance', ascending: true };
        let activeTypes = new Set(); // Aktiiviset lajit (kaikki oletuksena)
        let activeLevels = new Set(); // Aktiiviset tasot (kaikki oletuksena)

        // Haversine-kaava et√§isyyden laskemiseen
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Maapallon s√§de km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Laske et√§isyydet kaikille kokeille
        function calculateDistances() {
            kokeet.forEach(koe => {
                if (koe.coordinates && koe.coordinates.length === 2) {
                    koe.distance = Math.round(haversineDistance(
                        userLocation.lat, userLocation.lng,
                        koe.coordinates[0], koe.coordinates[1]
                    ));
                } else {
                    koe.distance = null;
                }
            });
        }

        // GPS-paikannus
        function useGPS() {
            const button = document.getElementById('gpsButton');
            button.disabled = true;
            button.innerHTML = '<span>‚è≥</span> Haetaan sijaintia...';

            if (!navigator.geolocation) {
                alert('Selaimesi ei tue paikannusta');
                button.disabled = false;
                button.innerHTML = '<span>üìç</span> K√§yt√§ sijaintiani';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        name: 'Nykyinen sijainti'
                    };
                    updateLocationDisplay();
                    calculateDistances();
                    sortAndRender();
                    button.disabled = false;
                    button.innerHTML = '<span>üìç</span> K√§yt√§ sijaintiani';
                },
                (error) => {
                    let message = 'Paikannusvirhe';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Sijainnin k√§ytt√∂ estetty';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Sijaintitietoa ei saatavilla';
                            break;
                        case error.TIMEOUT:
                            message = 'Paikannuspyynt√∂ aikakatkaistiin';
                            break;
                    }
                    alert(message);
                    button.disabled = false;
                    button.innerHTML = '<span>üìç</span> K√§yt√§ sijaintiani';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // P√§ivit√§ sijaintin√§ytt√∂
        function updateLocationDisplay() {
            const locationDisplay = document.getElementById('currentLocation');
            const locationName = document.getElementById('locationName');
            locationDisplay.style.display = 'flex';
            locationName.textContent = userLocation.name;
        }

        // Tekstihaku paikkakunnalle
        let searchTimeout;
        document.getElementById('locationInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.toLowerCase().trim();
            const suggestionsEl = document.getElementById('suggestions');

            if (query.length < 2) {
                suggestionsEl.classList.remove('active');
                return;
            }

            // Etsi ensin paikallisesta listasta
            const localMatches = Object.keys(finnishCities)
                .filter(city => city.includes(query))
                .slice(0, 5);

            if (localMatches.length > 0) {
                showSuggestions(localMatches.map(city => ({
                    name: city.charAt(0).toUpperCase() + city.slice(1),
                    lat: finnishCities[city].lat,
                    lng: finnishCities[city].lng
                })));
            } else {
                // Jos ei l√∂ydy paikallisesti, hae Nominatimista
                searchTimeout = setTimeout(() => searchNominatim(query), 500);
            }
        });

        async function searchNominatim(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)},Finland&limit=5&accept-language=fi`
                );
                const results = await response.json();

                if (results.length > 0) {
                    showSuggestions(results.map(r => ({
                        name: r.display_name.split(',')[0],
                        lat: parseFloat(r.lat),
                        lng: parseFloat(r.lon)
                    })));
                } else {
                    document.getElementById('suggestions').classList.remove('active');
                }
            } catch (error) {
                console.error('Nominatim-haku ep√§onnistui:', error);
            }
        }

        function showSuggestions(suggestions) {
            const suggestionsEl = document.getElementById('suggestions');
            suggestionsEl.innerHTML = suggestions.map(s =>
                `<div class="suggestion-item" onclick="selectLocation('${s.name}', ${s.lat}, ${s.lng})">${s.name}</div>`
            ).join('');
            suggestionsEl.classList.add('active');
        }

        function selectLocation(name, lat, lng) {
            userLocation = { lat, lng, name };
            document.getElementById('locationInput').value = '';
            document.getElementById('suggestions').classList.remove('active');
            updateLocationDisplay();
            calculateDistances();
            sortAndRender();
        }

        // Sulje suggestions kun klikataan muualle
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.location-input-wrapper')) {
                document.getElementById('suggestions').classList.remove('active');
            }
        });

        // Lataa data
        async function loadData() {
            try {
                // Yrit√§ ladata JSON-tiedosto
                const currentYear = new Date().getFullYear();
                const nextYear = currentYear + 1;

                // Kokeile ensin seuraavaa vuotta, sitten nykyist√§
                let response;
                let dataYear;

                try {
                    response = await fetch(`koetutka_${nextYear}.json`);
                    if (response.ok) {
                        dataYear = nextYear;
                    }
                } catch (e) {}

                if (!response || !response.ok) {
                    response = await fetch(`koetutka_${currentYear}.json`);
                    dataYear = currentYear;
                }

                if (!response.ok) {
                    throw new Error('Dataa ei voitu ladata');
                }

                kokeet = await response.json();
                document.getElementById('updateDate').textContent = `Vuosi ${dataYear}`;

                calculateDistances();
                populateFilters();
                sortAndRender();

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('kokeTable').style.display = 'table';

                // Aseta oletus sijainti
                updateLocationDisplay();

            } catch (error) {
                console.error('Virhe datan latauksessa:', error);
                document.getElementById('loadingIndicator').innerHTML =
                    'Virhe datan latauksessa. Tarkista ett√§ JSON-tiedosto on saatavilla.';
            }
        }

        // Populoi suodattimet
        function populateFilters() {
            const types = new Set();
            const levels = new Set(['ALO', 'AVO', 'VOI']); // Vain n√§m√§ tasot

            kokeet.forEach(koe => {
                types.add(koe.type);
            });

            // Luo lajipillerit
            const typePillsContainer = document.getElementById('typePills');
            const sortedTypes = Array.from(types).sort();

            sortedTypes.forEach(type => {
                const pill = document.createElement('div');
                pill.className = 'pill';
                pill.dataset.type = type;
                pill.innerHTML = `<span class="pill-label">${type}</span> <span class="pill-count"></span>`;
                pill.onclick = () => toggleTypePill(type);
                typePillsContainer.appendChild(pill);
            });

            // Luo tasopillerit (vain ALO, AVO, VOI)
            const levelPillsContainer = document.getElementById('levelPills');
            const sortedLevels = Array.from(levels).sort();

            sortedLevels.forEach(level => {
                const pill = document.createElement('div');
                pill.className = 'pill';
                pill.dataset.level = level;
                pill.innerHTML = `<span class="pill-label">${level}</span> <span class="pill-count"></span>`;
                pill.onclick = () => toggleLevelPill(level);
                levelPillsContainer.appendChild(pill);
            });
        }

        // P√§ivit√§ pillien lukum√§√§r√§t
        function updatePillCounts() {
            // Laske tyyppim√§√§r√§t (huomioi vain tasosuodatus)
            const typeCounts = {};
            const levelCounts = { 'ALO': 0, 'AVO': 0, 'VOI': 0 };
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            kokeet.forEach(koe => {
                const matchesSearch = !searchTerm ||
                    koe.location.toLowerCase().includes(searchTerm) ||
                    koe.type.toLowerCase().includes(searchTerm) ||
                    koe.levels.toLowerCase().includes(searchTerm) ||
                    (koe.name && koe.name.toLowerCase().includes(searchTerm));

                if (!matchesSearch) return;

                // Tyyppim√§√§r√§t (suodatettu tasoilla)
                let matchesLevel = activeLevels.size === 0;
                if (!matchesLevel) {
                    for (const level of activeLevels) {
                        if (koe.levels.includes(level)) {
                            matchesLevel = true;
                            break;
                        }
                    }
                }
                if (matchesLevel) {
                    typeCounts[koe.type] = (typeCounts[koe.type] || 0) + 1;
                }

                // Tasom√§√§r√§t (suodatettu tyypeill√§)
                const matchesType = activeTypes.size === 0 || activeTypes.has(koe.type);
                if (matchesType) {
                    ['ALO', 'AVO', 'VOI'].forEach(level => {
                        if (koe.levels.includes(level)) {
                            levelCounts[level]++;
                        }
                    });
                }
            });

            // P√§ivit√§ tyyppipillit
            document.querySelectorAll('#typePills .pill').forEach(pill => {
                const type = pill.dataset.type;
                const count = typeCounts[type] || 0;
                const countEl = pill.querySelector('.pill-count');
                countEl.textContent = count > 0 ? `(${count})` : '(0)';
                countEl.style.opacity = count > 0 ? '1' : '0.5';
            });

            // P√§ivit√§ tasopillit
            document.querySelectorAll('#levelPills .pill').forEach(pill => {
                const level = pill.dataset.level;
                const count = levelCounts[level] || 0;
                const countEl = pill.querySelector('.pill-count');
                countEl.textContent = count > 0 ? `(${count})` : '(0)';
                countEl.style.opacity = count > 0 ? '1' : '0.5';
            });
        }

        // Vaihda lajipillerin tilaa
        function toggleTypePill(type) {
            const pill = document.querySelector(`#typePills .pill[data-type="${type}"]`);

            if (activeTypes.has(type)) {
                activeTypes.delete(type);
                pill.classList.remove('active');
            } else {
                activeTypes.add(type);
                pill.classList.add('active');
            }

            sortAndRender();
        }

        // Vaihda tasopillerin tilaa
        function toggleLevelPill(level) {
            const pill = document.querySelector(`#levelPills .pill[data-level="${level}"]`);

            if (activeLevels.has(level)) {
                activeLevels.delete(level);
                pill.classList.remove('active');
            } else {
                activeLevels.add(level);
                pill.classList.add('active');
            }

            sortAndRender();
        }

        // Aseta j√§rjestys
        function setSortOrder(column) {
            // P√§ivit√§ pillit
            document.querySelectorAll('.pill[data-sort]').forEach(p => {
                p.classList.remove('active');
            });
            document.querySelector(`.pill[data-sort="${column}"]`).classList.add('active');

            // Aseta j√§rjestys
            currentSort = { column, ascending: true };
            sortAndRender();
        }

        // N√§yt√§ ohjeet
        function showHelp() {
            const modal = document.getElementById('infoModal');
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = `
                <h2>Ohjeet</h2>

                <div class="info-section">
                    <h3>üìÖ Lis√§√§ kalenteriin</h3>
                    <p>Klikkaa kokeen <strong style="color: #1565c0; border-bottom: 1px dashed #1565c0;">p√§iv√§m√§√§r√§√§</strong> tai <strong style="color: #1565c0; border-bottom: 1px dashed #1565c0;">ilmoittautumisp√§iv√§√§</strong> lis√§t√§ksesi tapahtuman kalenteriisi.</p>
                    <p style="margin-top: 8px; color: #666; font-size: 0.9em;">Kalenteritiedosto (.ics) toimii useimmissa kalenterisovelluksissa: Apple Calendar, Google Calendar, Outlook jne.</p>
                </div>

                <div class="info-section">
                    <h3>üîç Haku ja suodatus</h3>
                    <p><strong>Haku:</strong> Kirjoita hakukentt√§√§n paikkakunta, koelaji tai taso.</p>
                    <p><strong>Laji/Taso:</strong> Klikkaa pilleri√§ suodattaaksesi. Voit valita useita.</p>
                    <p><strong>J√§rjestys:</strong> Valitse et√§isyys tai ajankohta.</p>
                </div>

                <div class="info-section">
                    <h3>üìç Sijainti</h3>
                    <p>Anna sijaintisi n√§hd√§ksesi kokeiden et√§isyydet. Voit kirjoittaa paikkakunnan tai k√§ytt√§√§ GPS-paikannusta.</p>
                </div>

                <div class="info-section">
                    <h3>‚ÑπÔ∏è Lis√§tiedot</h3>
                    <p>Klikkaa koetta n√§hd√§ksesi lis√§tiedot: j√§rjest√§j√§, tuomarit, yhteystiedot ja hinnat.</p>
                </div>
            `;

            modal.style.display = 'block';
        }

        // Suodata ja j√§rjest√§
        function sortAndRender() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredKokeet = kokeet.filter(koe => {
                const matchesSearch = !searchTerm ||
                    koe.location.toLowerCase().includes(searchTerm) ||
                    koe.type.toLowerCase().includes(searchTerm) ||
                    koe.levels.toLowerCase().includes(searchTerm) ||
                    (koe.name && koe.name.toLowerCase().includes(searchTerm));

                // Tarkista onko laji aktiivinen
                const matchesType = activeTypes.size === 0 || activeTypes.has(koe.type);

                // Tarkista onko joku aktiivisista tasoista kokeessa
                let matchesLevel = activeLevels.size === 0;
                if (!matchesLevel) {
                    for (const level of activeLevels) {
                        if (koe.levels.includes(level)) {
                            matchesLevel = true;
                            break;
                        }
                    }
                }

                return matchesSearch && matchesType && matchesLevel;
            });

            // J√§rjest√§
            filteredKokeet.sort((a, b) => {
                let valA, valB;

                switch (currentSort.column) {
                    case 'distance':
                        valA = a.distance !== null ? a.distance : 99999;
                        valB = b.distance !== null ? b.distance : 99999;
                        break;
                    case 'date':
                        valA = a.date_sort || '';
                        valB = b.date_sort || '';
                        break;
                    default:
                        valA = a[currentSort.column] || '';
                        valB = b[currentSort.column] || '';
                }

                if (valA < valB) return currentSort.ascending ? -1 : 1;
                if (valA > valB) return currentSort.ascending ? 1 : -1;
                return 0;
            });

            renderTable();
            updateStats();
            updatePillCounts();
        }

        // P√§ivit√§ tilastot
        function updateStats() {
            // Laske tyypit
            const typeCounts = {};
            filteredKokeet.forEach(koe => {
                typeCounts[koe.type] = (typeCounts[koe.type] || 0) + 1;
            });

            // Desktop-tilastot
            const statsEl = document.getElementById('stats');
            statsEl.innerHTML = `
                <div class="stat-card">
                    <h3>${filteredKokeet.length}</h3>
                    <p>Koetta yhteens√§</p>
                </div>
            `;

            const sortedTypes = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 4);

            sortedTypes.forEach(([type, count]) => {
                statsEl.innerHTML += `
                    <div class="stat-card">
                        <h3>${count}</h3>
                        <p>${type}</p>
                    </div>
                `;
            });

            // Mobiili-tilastot (vain kokonaism√§√§r√§, tyyppim√§√§r√§t n√§kyv√§t filtteripilleiss√§)
            const statsMobileInner = document.getElementById('statsMobileInner');
            statsMobileInner.innerHTML = `
                <div class="stat-pill stat-pill-total">
                    <span class="stat-pill-count">${filteredKokeet.length}</span>
                    <span class="stat-pill-label">koetta n√§ytet√§√§n</span>
                </div>
            `;
        }

        // Render√∂i taulukko ja kortit
        function renderTable() {
            const tbody = document.getElementById('kokeTableBody');
            const cardsContainer = document.getElementById('cardsContainer');
            const noResults = document.getElementById('noResults');

            if (filteredKokeet.length === 0) {
                tbody.innerHTML = '';
                cardsContainer.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';

            // Render√∂i taulukko (desktop)
            tbody.innerHTML = filteredKokeet.map((koe, index) => {
                const typeClass = 'type-' + koe.type.replace(/[^a-zA-Z0-9-]/g, '-');
                const distanceStr = koe.distance !== null
                    ? `<span class="distance">${koe.distance} km</span>`
                    : `<span class="distance-unknown">-</span>`;

                return `
                    <tr>
                        <td>${distanceStr}</td>
                        <td class="date">${koe.date}</td>
                        <td>${koe.location}</td>
                        <td style="text-align: center; width: 40px;">
                            <button class="btn btn-info" onclick="showInfo(${index})" title="N√§yt√§ lis√§tiedot">
                                <span class="btn-icon">‚ÑπÔ∏è</span><span class="btn-text">Info</span>
                            </button>
                        </td>
                        <td><span class="type-badge ${typeClass}">${koe.type}</span></td>
                        <td>${koe.levels}</td>
                        <td>${koe.entry_date}</td>
                        <td style="text-align: center; width: 40px;">
                            <button class="btn btn-calendar" onclick="downloadICS(${index})" title="Lis√§√§ kalenteriin">
                                <span class="btn-icon">üìÖ</span><span class="btn-text">Kalenteri</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Render√∂i kortit (desktop + mobiili, eri layout CSS:ll√§)
            cardsContainer.innerHTML = filteredKokeet.map((koe, index) => {
                const typeClass = 'type-' + koe.type.replace(/[^a-zA-Z0-9-]/g, '-');
                const distanceStr = koe.distance !== null
                    ? `${koe.distance} km`
                    : '-';
                const title = koe.name || `${koe.type} ${koe.location}`;

                return `
                    <div class="event-card" onclick="showInfo(${index})">
                        <div class="card-distance">
                            ${distanceStr}
                            <div class="card-distance-label">et√§isyys</div>
                        </div>
                        <div class="card-main-info">
                            <div class="card-title" title="${title}">${title}</div>
                            <div class="card-subtitle">
                                <span class="card-subtitle-item card-date" onclick="event.stopPropagation(); downloadICS(${index})" title="Lis√§√§ koe kalenteriin">
                                    <span class="card-calendar-link">üìÖ ${koe.date}</span>
                                </span>
                                <span class="card-subtitle-item">üìç ${koe.location}</span>
                                <span class="card-subtitle-item" onclick="event.stopPropagation(); downloadICS(${index})" title="Lis√§√§ ilmoittautumismuistutus kalenteriin">
                                    <span class="card-calendar-link">‚úèÔ∏è Ilmo: ${koe.entry_date}</span>
                                </span>
                                ${koe.organizer ? `<span class="card-subtitle-item card-organizer">üè¢ ${koe.organizer}</span>` : ''}
                            </div>
                        </div>
                        <div class="card-badges">
                            <span class="type-badge ${typeClass}">${koe.type}</span>
                            <span class="type-badge" style="background: #f5f5f5; color: #333;">${koe.levels}</span>
                        </div>
                        <div class="card-meta-mobile">
                            <div class="card-meta-item" onclick="event.stopPropagation(); downloadICS(${index})" title="Lis√§√§ ilmoittautumismuistutus kalenteriin">
                                <span class="card-calendar-link">‚úèÔ∏è Ilmo: ${koe.entry_date}</span>
                            </div>
                            ${koe.organizer ? `<div class="card-meta-item">üè¢ ${koe.organizer}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Sarakkeen klikkaus j√§rjest√§miseen
        document.querySelectorAll('thead th.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.sort;
                const isAscending = currentSort.column === column ? !currentSort.ascending : true;
                currentSort = { column, ascending: isAscending };

                // P√§ivit√§ visuaalinen merkint√§
                document.querySelectorAll('thead th').forEach(h => {
                    h.classList.remove('sorted-asc', 'sorted-desc');
                });
                this.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');

                // P√§ivit√§ j√§rjestysinfo
                const columnNames = {
                    'distance': 'et√§isyys',
                    'date': 'p√§iv√§m√§√§r√§',
                    'location': 'paikkakunta',
                    'type': 'tyyppi',
                    'levels': 'taso',
                    'entry_date': 'ilmoittautuminen'
                };
                document.getElementById('sortInfo').textContent =
                    `J√§rjestetty: ${columnNames[column]} ${isAscending ? '‚Üë' : '‚Üì'}`;

                sortAndRender();
            });
        });

        // N√§yt√§ info-modal
        function showInfo(index) {
            const koe = filteredKokeet[index];
            const modal = document.getElementById('infoModal');
            const modalBody = document.getElementById('modalBody');

            let html = `<h2>${koe.name || koe.type + ' ' + koe.location}</h2>`;

            html += `<div class="info-section">
                <h3>Perustiedot</h3>
                <p><span class="info-label">P√§iv√§m√§√§r√§:</span> ${koe.date}</p>
                <p><span class="info-label">Paikkakunta:</span> ${koe.location}</p>
                <p><span class="info-label">Tyyppi:</span> ${koe.type}</p>
                <p><span class="info-label">Tasot:</span> ${koe.levels}</p>
                <p style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <span><span class="info-label">Ilmoittautuminen p√§√§ttyy:</span> ${koe.entry_date}</span>
                    <button class="btn btn-calendar" style="padding: 6px 12px;" onclick="downloadICS(${index}); closeModal();" title="Lis√§√§ muistutus kalenteriin">
                        <span class="btn-icon">üìÖ</span>
                        <span class="btn-text">Muistutus kalenteriin</span>
                    </button>
                </p>
            </div>`;

            if (koe.distance !== null) {
                html += `<div class="info-section">
                    <h3>Et√§isyys sijainnistasi</h3>
                    <p><span class="info-label">Linnuntie:</span> ${koe.distance} km</p>
                </div>`;
            }

            if (koe.organizer) {
                html += `<div class="info-section">
                    <h3>J√§rjest√§j√§</h3>
                    <p>${koe.organizer}</p>
                </div>`;
            }

            if (koe.judges && koe.judges.length > 0) {
                html += `<div class="info-section">
                    <h3>Tuomarit</h3>
                    <p>${koe.judges.join(', ')}</p>
                </div>`;
            }

            if (koe.official && koe.official.name) {
                html += `<div class="info-section">
                    <h3>Virallinen yhteyshenkil√∂</h3>
                    <p><span class="info-label">Nimi:</span> ${koe.official.name}</p>
                    ${koe.official.phone ? `<p><span class="info-label">Puhelin:</span> ${koe.official.phone}</p>` : ''}
                    ${koe.official.email ? `<p><span class="info-label">S√§hk√∂posti:</span> <a href="mailto:${koe.official.email}">${koe.official.email}</a></p>` : ''}
                </div>`;
            }

            if (koe.secretary && koe.secretary.name) {
                html += `<div class="info-section">
                    <h3>Sihteeri</h3>
                    <p><span class="info-label">Nimi:</span> ${koe.secretary.name}</p>
                    ${koe.secretary.phone ? `<p><span class="info-label">Puhelin:</span> ${koe.secretary.phone}</p>` : ''}
                    ${koe.secretary.email ? `<p><span class="info-label">S√§hk√∂posti:</span> <a href="mailto:${koe.secretary.email}">${koe.secretary.email}</a></p>` : ''}
                </div>`;
            }

            if (koe.cost || koe.cost_member) {
                html += `<div class="info-section">
                    <h3>Osallistumismaksut</h3>
                    ${koe.cost ? `<p><span class="info-label">Maksu:</span> ${koe.cost} ‚Ç¨</p>` : ''}
                    ${koe.cost_member ? `<p><span class="info-label">J√§senmaksu:</span> ${koe.cost_member} ‚Ç¨</p>` : ''}
                </div>`;
            }

            if (koe.description) {
                html += `<div class="info-section">
                    <h3>Lis√§tiedot</h3>
                    <p>${koe.description.replace(/\n/g, '<br>')}</p>
                </div>`;
            }

            html += `<div class="info-section" style="text-align: center; margin-top: 20px;">
                <a href="https://koekalenteri.snj.fi/" target="_blank" rel="noopener" class="btn btn-snj">
                    Ilmoittaudu SNJ:n koekalenterissa
                </a>
            </div>`;

            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        // Sulje modal
        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // Sulje modal kun klikataan modaalin ulkopuolella
        window.onclick = function(event) {
            const modal = document.getElementById('infoModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Sulje modal ESC-n√§pp√§imell√§
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Lataa ICS kalenteritiedosto
        function downloadICS(index) {
            const koe = filteredKokeet[index];

            const dateStr = koe.date_sort;
            const date = new Date(dateStr);

            const formatDateOnly = (d) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return d.getFullYear() +
                    pad(d.getMonth() + 1) +
                    pad(d.getDate());
            };

            const formatICSTimestamp = (d) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return d.getUTCFullYear() +
                    pad(d.getUTCMonth() + 1) +
                    pad(d.getUTCDate()) + 'T' +
                    pad(d.getUTCHours()) +
                    pad(d.getUTCMinutes()) +
                    pad(d.getUTCSeconds()) + 'Z';
            };

            const dtstart = formatDateOnly(date);

            let endDate;
            if (koe.end_date_sort) {
                endDate = new Date(koe.end_date_sort);
                endDate.setDate(endDate.getDate() + 1);
            } else {
                endDate = new Date(date);
                endDate.setDate(endDate.getDate() + 1);
            }
            const dtend = formatDateOnly(endDate);

            let description = '';

            if (koe.description) {
                description += koe.description;
                description += `\\n\\n--- Perustiedot ---\\n`;
            }

            description += `Tyyppi: ${koe.type}\\n`;

            if (koe.classes && koe.classes.length > 0) {
                description += `\\nLuokat ja p√§iv√§t:\\n`;

                const classesByDate = {};
                const weekdays = ['Su', 'Ma', 'Ti', 'Ke', 'To', 'Pe', 'La'];

                koe.classes.forEach(cls => {
                    if (cls.class && cls.date) {
                        const clsDate = new Date(cls.date);
                        const dateKey = formatDateOnly(clsDate);
                        const dayName = weekdays[clsDate.getDay()];
                        const dateStr = clsDate.getDate() + '.' + (clsDate.getMonth() + 1) + '.';

                        if (!classesByDate[dateKey]) {
                            classesByDate[dateKey] = {
                                dateStr: dateStr,
                                dayName: dayName,
                                classes: []
                            };
                        }
                        classesByDate[dateKey].classes.push(cls.class);
                    }
                });

                Object.keys(classesByDate).sort().forEach(dateKey => {
                    const info = classesByDate[dateKey];
                    description += `  ${info.dayName} ${info.dateStr}: ${info.classes.join(', ')}\\n`;
                });
            } else {
                description += `Tasot: ${koe.levels}\\n`;
            }
            if (koe.organizer) description += `\\n\\nJ√§rjest√§j√§: ${koe.organizer}`;
            if (koe.judges && koe.judges.length > 0) description += `\\n\\nTuomarit: ${koe.judges.join(', ')}`;

            if (koe.secretary && koe.secretary.name) {
                description += `\\n\\nSihteeri: ${koe.secretary.name}`;
                if (koe.secretary.phone) description += `, puh. ${koe.secretary.phone}`;
                if (koe.secretary.email) description += `, ${koe.secretary.email}`;
            }
            if (koe.official && koe.official.name) {
                description += `\\n\\nYhteyshenkil√∂: ${koe.official.name}`;
                if (koe.official.phone) description += `, puh. ${koe.official.phone}`;
                if (koe.official.email) description += `, ${koe.official.email}`;
            }

            if (koe.distance !== null) {
                description += `\\n\\n--- Et√§isyys (${userLocation.name}) ---`;
                description += `\\nLinnuntie: ${koe.distance} km`;
            }

            description += `\\n\\nIlmoittautuminen p√§√§ttyy: ${koe.entry_date}`;

            if (koe.cost || koe.cost_member) {
                description += `\\n\\n--- Osallistumismaksut ---`;
                if (koe.cost) description += `\\nMaksu: ${koe.cost} ‚Ç¨`;
                if (koe.cost_member) description += `\\nJ√§senmaksu: ${koe.cost_member} ‚Ç¨`;
            }

            const title = `${koe.location} - ${koe.type} - ${koe.levels}`;
            const location = koe.location + (koe.coordinates ? ` (${koe.coordinates[0]}, ${koe.coordinates[1]})` : '');

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Koetutka//FI',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'BEGIN:VEVENT',
                `DTSTART;VALUE=DATE:${dtstart}`,
                `DTEND;VALUE=DATE:${dtend}`,
                `DTSTAMP:${formatICSTimestamp(new Date())}`,
                `UID:${koe.date_sort}-${index}@koetutka.fi`,
                `SUMMARY:${title}`,
                `DESCRIPTION:${description}`,
                `LOCATION:${location}`,
                'STATUS:CONFIRMED',
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `koetutka-${koe.location}-${koe.date.replace(/\./g, '-')}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listenerit
        document.getElementById('searchInput').addEventListener('input', sortAndRender);

        // Alustus
        loadData();
    </script>
</body>
</html>
